"use strict";var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);i.prototype=e.prototype,t.prototype=new i},__decorate=this&&this.__decorate||function(t,e,i,s){var r,o=arguments.length,n=3>o?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,i,s);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(n=(3>o?r(n):o>3?r(e,i,n):r(e,i))||n);return o>3&&n&&Object.defineProperty(e,i,n),n},egret3d;!function(t){var e;!function(e){function i(e,i){return(new t.Vector3).add(e,i)}function s(e,i){return(new t.Vector3).subtract(e,i)}function r(e,i){return(new t.Vector3).multiplyScalar(i,e)}function o(e,i){return(new t.Vector3).cross(e,i)}var n=function(){function n(){this._maxFragmentCount=300,this._points=[],this._lastFrameEmit=!0,this._pausedTime=-1,this._verticles=[],this._uvs=[],this._colors=[],this._indices=[],this._pointDistances=[0],this._distanceSum=0}return n.prototype.pause=function(){this._pausedTime=paper.clock.timestamp()},n.prototype.resume=function(){this._pausedTime<0&&console.warn("_pausedTime should not be less than 0 in TrailBatcher.resume()");for(var t=paper.clock.timestamp()-this._pausedTime,e=0,i=this._points;e<i.length;e++){var s=i[e];s.timeCreated+=t}},n.prototype.clean=function(){this._lastPosition=void 0,this._points.length=0,this._pausedTime=-1,this._resetMeshData()},n.prototype.init=function(t){this._comp=t,this._createMesh()},n.prototype.connectRenderer=function(){var e=this._comp.gameObject.getComponent(t.MeshFilter);return e?void(e.mesh=this._mesh):void console.warn("")},n.prototype.update=function(t){if(this._comp){var e=this._comp;if(!e.isPaused){e.isPlaying||e.autoDestruct&&this._points.length<2&&e.gameObject.destroy();var i=paper.clock.timestamp();this._updateSegments(i),this._rebuildMeshData(i),this._composeMesh()}}},n.prototype._updateSegments=function(e){var i=this._comp,s=i.transform.position,r=this._lastPosition?s.getDistance(this._lastPosition):-1,o=this._points.length,n=i.isPlaying,a=this._points[o-1];if(n)if(r>i.minVertexDistance||0>r){if(this._points.push({position:t.Vector3.create().copy(s),timeCreated:e,lineBreak:!1}),this._lastPosition||(this._lastPosition=t.Vector3.create()),this._lastPosition.copy(s),a){var p=a.position.getDistance(s);this._pointDistances.push(p),this._distanceSum+=p}}else if(o>0&&(a.position.copy(s),a.timeCreated=e,o>1)){var p=a.position.getDistance(this._points[o-2].position);this._distanceSum=this._distanceSum-this._pointDistances[o-1]+p,this._pointDistances[o-1]=p}!n&&this._lastFrameEmit&&o>0&&(a.lineBreak=!0,this._lastFrameEmit=!1),this._removeDeadPoints(e,1e3*i.time)},n.prototype._removeDeadPoints=function(t,e){var i=this._points.length;if(0!==i)for(var s=0;i>s;s++)if(t-this._points[s].timeCreated<e){if(s>0){this._points.splice(0,s);for(var r=0;s>r;r++)this._distanceSum-=this._pointDistances[r];this._pointDistances.splice(0,s)}break}},n.prototype._rebuildMeshData=function(t){this._resetMeshData();var n=this._points.length;if(!(2>n)){var a=this._getCamera();if(a)for(var p=this._comp,c=0,h=0;n>h;++h){var _=this._points[h],l=(t-_.timeCreated)/p.time,u=this._getColorSample(p,l),d=this._getWidthSample(p,l),m=0===h?s(_.position,this._points[h+1].position):s(this._points[h-1].position,_.position),f=s(a.transform.position,_.position),y=o(m,f).normalize(),g=void 0;if(g=i(_.position,r(y,.5*d)),this._verticles[6*h+0]=g.x,this._verticles[6*h+1]=g.y,this._verticles[6*h+2]=g.z,g=i(_.position,r(y,.5*-d)),this._verticles[6*h+3]=g.x,this._verticles[6*h+4]=g.y,this._verticles[6*h+5]=g.z,this._colors[8*h+0]=u.r,this._colors[8*h+1]=u.g,this._colors[8*h+2]=u.b,this._colors[8*h+3]=u.a,this._colors[8*h+4]=u.r,this._colors[8*h+5]=u.g,this._colors[8*h+6]=u.b,this._colors[8*h+7]=u.a,p.textureMode===e.TrailTextureMode.Stretch){var v=this._distanceSum?this._pointDistances[h]/this._distanceSum:0;c+=v,this._uvs[4*h+0]=c,this._uvs[4*h+1]=1,this._uvs[4*h+2]=c,this._uvs[4*h+3]=0}else this._uvs[2*h+0]=0,this._uvs[2*h+1]=1,this._uvs[2*h+0]=0,this._uvs[2*h+1]=0;h>0&&!this._points[n-1].lineBreak&&(this._indices[6*(h-1)+0]=2*h-2,this._indices[6*(h-1)+1]=2*h-1,this._indices[6*(h-1)+2]=2*h,this._indices[6*(h-1)+3]=2*h+1,this._indices[6*(h-1)+4]=2*h,this._indices[6*(h-1)+5]=2*h-1)}}},n.prototype._getColorSample=function(t,e){return t.color},n.prototype._getWidthSample=function(t,e){return t.width},n.prototype._getCamera=function(){return t.Camera.main},n.prototype._resetMeshData=function(){this._verticles.length=0,this._uvs.length=0,this._colors.length=0,this._indices.length=0},n.prototype._composeMesh=function(){this._points.length>this._maxFragmentCount&&this._createMesh();var t=this._mesh.getAttributes("POSITION");t&&t.fill(0),this._mesh.setAttributes("POSITION",this._verticles),t=this._mesh.getAttributes("TEXCOORD_0"),t&&t.fill(0),this._mesh.setAttributes("TEXCOORD_0",this._uvs),t=this._mesh.getAttributes("COLOR_0"),t&&t.fill(0),this._mesh.setAttributes("COLOR_0",this._colors),t=this._mesh.getIndices(),t&&t.fill(0),this._mesh.setIndices(this._indices),this._mesh.uploadVertexBuffer(),this._mesh.uploadSubIndexBuffer(0)},n.prototype._createMesh=function(){this._mesh=t.Mesh.create(4*this._maxFragmentCount,6*(this._maxFragmentCount-1)),this.connectRenderer()},n}();e.TrailBatcher=n,__reflect(n.prototype,"egret3d.trail.TrailBatcher")}(e=t.trail||(t.trail={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var i;!function(t){t[t.View=0]="View",t[t.Local=1]="Local"}(i=e.TrailAlignment||(e.TrailAlignment={}));var s;!function(t){t[t.Tiling=0]="Tiling",t[t.Stretch=1]="Stretch"}(s=e.TrailTextureMode||(e.TrailTextureMode={}));var r=function(r){function o(){var o=null!==r&&r.apply(this,arguments)||this;return o.time=3,o.minVertexDistance=.1,o.width=1,o.color=t.Color.WHITE,o.autoDestruct=!1,o.Alignment=i.View,o.textureMode=s.Stretch,o._isPlaying=!1,o._isPaused=!1,o._timeScale=1,o._batcher=new e.TrailBatcher,o}return __extends(o,r),o.prototype._clean=function(){this._batcher.clean()},o.prototype.initialize=function(){r.prototype.initialize.call(this),this._batcher.init(this),this._clean()},o.prototype.uninitialize=function(){r.prototype.uninitialize.call(this),this._clean()},o.prototype.update=function(t){this._batcher.update(t*this._timeScale)},o.prototype.play=function(){this._isPlaying=!0,this._isPaused=!1,this._batcher.clean()},o.prototype.resume=function(){if(this._isPaused)this._isPaused=!1,this._batcher.resume();else{if(this._isPlaying)return;this.play()}},o.prototype.pause=function(){this._isPlaying&&(this._isPaused=!0)},o.prototype.stop=function(){this._isPlaying=!1,this._isPaused=!1},Object.defineProperty(o.prototype,"isPlaying",{get:function(){return this._isPlaying},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"isPaused",{get:function(){return this._isPaused},enumerable:!0,configurable:!0}),o.prototype.syncRenderer=function(){this._batcher.connectRenderer()},__decorate([paper.serializedField,paper.editor.property("FLOAT",{minimum:0})],o.prototype,"time",void 0),__decorate([paper.serializedField,paper.editor.property("FLOAT",{minimum:0})],o.prototype,"minVertexDistance",void 0),__decorate([paper.serializedField,paper.editor.property("FLOAT",{minimum:0})],o.prototype,"width",void 0),__decorate([paper.serializedField,paper.editor.property("COLOR")],o.prototype,"color",void 0),__decorate([paper.serializedField,paper.editor.property("CHECKBOX")],o.prototype,"autoDestruct",void 0),__decorate([paper.serializedField],o.prototype,"Alignment",void 0),__decorate([paper.serializedField],o.prototype,"textureMode",void 0),o}(paper.BaseComponent);e.TrailComponent=r,__reflect(r.prototype,"egret3d.trail.TrailComponent")}(e=t.trail||(t.trail={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){function i(e){var i=t.creater.createGameObject(e);return i.addComponent(t.trail.TrailComponent),i}var s=function(i){function s(){return null!==i&&i.apply(this,arguments)||this}return __extends(s,i),s.prototype.getMatchers=function(){return[paper.Matcher.create(t.Transform,t.MeshFilter,t.MeshRenderer,e.TrailComponent)]},s.prototype.onFrame=function(t){for(var i=0,s=this.groups[0].entities;i<s.length;i++){var r=s[i],o=r.getComponent(e.TrailComponent);o&&o.update(t)}},s}(paper.BaseSystem);e.TrailSystem=s,__reflect(s.prototype,"egret3d.trail.TrailSystem"),e.createTrail=i,paper.Application.systemManager.preRegister(s,paper.Application.gameObjectContext,6999)}(e=t.trail||(t.trail={}))}(egret3d||(egret3d={}));