"use strict";var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);i.prototype=e.prototype,t.prototype=new i},__decorate=this&&this.__decorate||function(t,e,i,s){var r,o=arguments.length,n=3>o?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,i,s);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(n=(3>o?r(n):o>3?r(e,i,n):r(e,i))||n);return o>3&&n&&Object.defineProperty(e,i,n),n},egret3d;!function(t){var e;!function(e){function i(e,i){return(new t.Vector3).add(e,i)}function s(e,i){return(new t.Vector3).subtract(e,i)}function r(e,i){return(new t.Vector3).multiplyScalar(i,e)}function o(e,i){return(new t.Vector3).cross(e,i)}var n=function(){function n(){this._maxFragmentCount=300,this._points=[],this._lastFrameEmit=!0,this._pausedTime=-1,this._verticles=[],this._uvs=[],this._colors=[],this._indices=[]}return n.prototype.pause=function(){this._pausedTime=paper.clock.timestamp()},n.prototype.resume=function(){this._pausedTime<0&&console.warn("_pausedTime should not be less than 0 in TrailBatcher.resume()");for(var t=paper.clock.timestamp()-this._pausedTime,e=0,i=this._points;e<i.length;e++){var s=i[e];s.timeCreated+=t}},n.prototype.clean=function(){this._lastPosition=void 0,this._points.length=0,this._pausedTime=-1,this._resetMeshData()},n.prototype.init=function(t){this._comp=t,this._createMesh()},n.prototype.update=function(t){if(this._comp){var e=this._comp;if(!e.isPaused){e.isPlaying||e.autoDestruct&&this._points.length<2&&e.gameObject.destroy();var i=paper.clock.timestamp();this._updateSegments(i),this._rebuildMeshData(i),this._composeMesh()}}},n.prototype._updateSegments=function(t){var e=this._comp,i=e.transform.position,s=this._lastPosition?i.getDistance(this._lastPosition):-1,r=this._points.length,o=e.isPlaying;if(o)if(s>e.minVertexDistance||0>s)this._points.push({position:i,timeCreated:t,lineBreak:!1}),this._lastPosition=i;else if(r>0){var n=this._points[r-1];n.position=i,n.timeCreated=t}!o&&this._lastFrameEmit&&r>0&&(this._points[r-1].lineBreak=!0,this._lastFrameEmit=!1),this._removeDeadPoints(t,e.time)},n.prototype._removeDeadPoints=function(t,e){var i=this._points.length;if(0!==i)for(var s=0;i>s;s++)if(t-this._points[s].timeCreated<e){s>0&&(this._points=this._points.splice(0,s));break}},n.prototype._rebuildMeshData=function(t){var n=.01;this._resetMeshData();var a=this._points.length;if(!(2>a)){var p=this._getCamera();if(p)for(var h=0,l=this._comp,c=0;a>c;++c){var _=this._points[c],u=(t-_.timeCreated)/l.time,d=this._getColorSample(l,u),m=this._getWidthSample(l,u),f=0===c?s(_.position,this._points[c+1].position):s(this._points[c-1].position,_.position),g=s(p.transform.position,_.position),y=o(f,g).normalize(),v=void 0;v=i(_.position,r(y,.5*m)),this._verticles[6*c+0]=v.x,this._verticles[6*c+1]=v.y,this._verticles[6*c+2]=v.z,v=i(_.position,r(y,.5*-m)),this._verticles[6*c+3]=v.x,this._verticles[6*c+4]=v.y,this._verticles[6*c+5]=v.z,this._colors[8*c+0]=d.r,this._colors[8*c+1]=d.g,this._colors[8*c+2]=d.b,this._colors[8*c+3]=d.a,this._colors[8*c+4]=d.r,this._colors[8*c+5]=d.g,this._colors[8*c+6]=d.b,this._colors[8*c+7]=d.a,l.textureMode===e.TrailTextureMode.Stretch?(this._uvs[2*c+0]=h*n,this._uvs[2*c+1]=1,this._uvs[2*c+0]=h*n,this._uvs[2*c+1]=0):(this._uvs[2*c+0]=0,this._uvs[2*c+1]=1,this._uvs[2*c+0]=0,this._uvs[2*c+1]=0),c>0&&!this._points[a-1].lineBreak&&(h+=_.position.getDistance(this._points[a-1].position),this._indices[6*(c-1)+0]=2*c-2,this._indices[6*(c-1)+1]=2*c-1,this._indices[6*(c-1)+2]=2*c,this._indices[6*(c-1)+3]=2*c+1,this._indices[6*(c-1)+4]=2*c,this._indices[6*(c-1)+5]=2*c-1)}}},n.prototype._getColorSample=function(e,i){var s=t.Color.create();if(e.colors.length>0){var r=i*(e.colors.length-1),o=Math.floor(r),n=t.math.clamp(Math.ceil(r),0,e.colors.length-1),a=t.math.inverseLerp(o,n,r);s.lerp(a,e.colors[o],e.colors[n])}else s.lerp(i,t.Color.WHITE,t.Color.ZERO);return s},n.prototype._getWidthSample=function(e,i){var s;if(e.widths.length>0){var r=i*(e.widths.length-1),o=Math.floor(r),n=t.math.clamp(Math.ceil(r),0,e.widths.length-1),a=t.math.inverseLerp(o,n,r);s=t.math.lerp(e.widths[o],e.widths[n],a)}else s=1;return s},n.prototype._getCamera=function(){return t.Camera.main},n.prototype._resetMeshData=function(){this._verticles.length=0,this._uvs.length=0,this._colors.length=0,this._indices.length=0},n.prototype._composeMesh=function(){this._points.length>this._maxFragmentCount&&this._createMesh(),this._mesh.setAttributes("POSITION",this._verticles),this._mesh.setAttributes("TEXCOORD_0",this._uvs),this._mesh.setAttributes("COLOR_0",this._colors),this._mesh.setIndices(this._indices)},n.prototype._createMesh=function(){this._mesh=t.Mesh.create(4*this._maxFragmentCount,6*(this._maxFragmentCount-1))},n}();e.TrailBatcher=n,__reflect(n.prototype,"egret3d.trail.TrailBatcher")}(e=t.trail||(t.trail={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e;!function(t){t[t.View=0]="View",t[t.Local=1]="Local"}(e=t.TrailAlignment||(t.TrailAlignment={}));var i;!function(t){t[t.Tiling=0]="Tiling",t[t.Stretch=1]="Stretch"}(i=t.TrailTextureMode||(t.TrailTextureMode={}));var s=function(s){function r(){var r=null!==s&&s.apply(this,arguments)||this;return r.time=1,r.minVertexDistance=.1,r.widths=[],r.colors=[],r.autoDestruct=!0,r.Alignment=e.View,r.textureMode=i.Tiling,r._isPlaying=!1,r._isPaused=!1,r._timeScale=1,r._batcher=new t.TrailBatcher,r}return __extends(r,s),r.prototype._clean=function(){this._batcher.clean()},r.prototype.initialize=function(){s.prototype.initialize.call(this),this._clean()},r.prototype.uninitialize=function(){s.prototype.uninitialize.call(this),this._clean()},r.prototype.initBatcher=function(){this._batcher.init(this)},r.prototype.update=function(t){this._batcher.update(t*this._timeScale)},r.prototype.play=function(){this._isPlaying=!0,this._isPaused=!1,this._batcher.clean()},r.prototype.resume=function(){if(this._isPaused)this._isPaused=!1,this._batcher.resume();else{if(this._isPlaying)return;this.play()}},r.prototype.pause=function(){this._isPlaying&&(this._isPaused=!0)},r.prototype.stop=function(){this._isPlaying=!1,this._isPaused=!1},Object.defineProperty(r.prototype,"isPlaying",{get:function(){return this._isPlaying},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isPaused",{get:function(){return this._isPaused},enumerable:!0,configurable:!0}),__decorate([paper.serializedField],r.prototype,"time",void 0),__decorate([paper.serializedField],r.prototype,"minVertexDistance",void 0),__decorate([paper.serializedField],r.prototype,"widths",void 0),__decorate([paper.serializedField],r.prototype,"colors",void 0),__decorate([paper.serializedField],r.prototype,"autoDestruct",void 0),__decorate([paper.serializedField],r.prototype,"material",void 0),__decorate([paper.serializedField],r.prototype,"Alignment",void 0),__decorate([paper.serializedField],r.prototype,"textureMode",void 0),r}(paper.BaseComponent);t.TrailComponent=s,__reflect(s.prototype,"egret3d.trail.TrailComponent")}(e=t.trail||(t.trail={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(e){var i=function(i){function s(){return null!==i&&i.apply(this,arguments)||this}return __extends(s,i),s.prototype.getMatchers=function(){return[paper.Matcher.create(t.Transform,t.MeshFilter,t.MeshRenderer,e.TrailComponent)]},s.prototype.onFrame=function(t){for(var i=0,s=this.groups[0].entities;i<s.length;i++){var r=s[i],o=r.getComponent(e.TrailComponent);o&&o.update(t)}},s}(paper.BaseSystem);e.TrailSystem=i,__reflect(i.prototype,"egret3d.trail.TrailSystem")}(e=t.trail||(t.trail={}))}(egret3d||(egret3d={}));